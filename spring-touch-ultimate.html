<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Touch Training - Ultimate Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2c 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2d5016;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px;
        }

        .badge.premium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .role-selector {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .role-btn {
            flex: 1;
            padding: 30px;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .role-btn:hover {
            border-color: #4a7c2c;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 124, 44, 0.3);
        }

        .role-btn.active {
            border-color: #2d5016;
            background: #f0fdf4;
        }

        .role-btn h3 {
            color: #2d5016;
            margin-bottom: 10px;
        }

        .user-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 2fr 4fr;
            gap: 20px;
        }

        .user-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-input label {
            color: #2d5016;
            font-weight: 600;
        }

        .user-input input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #e6f7ed 100%);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #4a7c2c;
        }

        .stat-box .label {
            color: #2d5016;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stat-box .value {
            color: #2d5016;
            font-size: 1.8em;
            font-weight: 700;
        }

        .tabs {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .tab-buttons {
            display: flex;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #2d5016;
            border-bottom: 3px solid #4a7c2c;
        }

        .tab-button.manager-only {
            background: #fef3c7;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #2d5016;
            margin-bottom: 20px;
        }

        .scenario-selector {
            margin-bottom: 20px;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .difficulty-badge.easy {
            background: #c6f6d5;
            color: #22543d;
        }

        .difficulty-badge.medium {
            background: #feebc8;
            color: #7c2d12;
        }

        .difficulty-badge.hard {
            background: #fed7d7;
            color: #742a2a;
        }

        .scenario-selector label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .scenario-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .adaptive-notice {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }

        .scenario-info {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4a7c2c;
        }

        .metrics-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .receptiveness-bar-container {
            background: #e2e8f0;
            height: 20px;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .receptiveness-bar {
            background: linear-gradient(90deg, #f56565 0%, #ed8936 33%, #ecc94b 66%, #48bb78 100%);
            height: 100%;
            width: 50%;
            transition: width 0.5s;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status.waiting {
            background: #bee3f8;
            color: #2c5282;
        }

        .status.speaking {
            background: #c6f6d5;
            color: #22543d;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a7c2c 0%, #2d5016 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 124, 44, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-area textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .conversation {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            line-height: 1.6;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.customer {
            background: #fff5f5;
            border-left: 4px solid #f56565;
        }

        .message.agent {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
        }

        .message strong {
            display: block;
            margin-bottom: 5px;
        }

        .upload-zone {
            border: 3px dashed #4a7c2c;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0fdf4;
        }

        .upload-zone:hover {
            background: #e6f7ed;
            border-color: #2d5016;
        }

        .upload-zone.dragover {
            background: #d1fae5;
            transform: scale(1.02);
        }

        .call-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .call-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7c2c;
        }

        .history-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .history-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7c2c;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #e6f7ed;
            transform: translateX(5px);
        }

        .history-item .date {
            color: #718096;
            font-size: 0.9em;
        }

        .history-item .score {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d5016;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4a7c2c;
        }

        .insight-card h4 {
            color: #2d5016;
            margin-bottom: 10px;
        }

        .chart-container {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .leaderboard {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .leaderboard-rank {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d5016;
            width: 40px;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-score {
            font-size: 1.2em;
            font-weight: 700;
            color: #4a7c2c;
        }

        .team-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #e6f7ed 100%);
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #4a7c2c;
            text-align: center;
        }

        .metric-card .value {
            font-size: 3em;
            font-weight: 700;
            color: #2d5016;
            margin-bottom: 10px;
        }

        .metric-card .label {
            color: #4a5568;
            font-weight: 600;
        }

        .agent-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .agent-table th {
            background: #2d5016;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .agent-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .agent-table tr:hover {
            background: #f0fdf4;
        }

        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a7c2c 0%, #2d5016 100%);
            transition: width 0.3s;
        }

        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-box.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-box.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-box.info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåø Spring Touch Training Center - Ultimate Edition</h1>
            <p>Complete AI Training System with Analytics, Adaptive Learning & Team Management</p>
            <div>
                <span class="badge">üìä Progress Tracking</span>
                <span class="badge">üß† Adaptive Difficulty</span>
                <span class="badge">üèÜ Leaderboard</span>
                <span class="badge premium">üìà Team Analytics</span>
                <span class="badge premium">üìÅ Excel Export</span>
                <span class="badge premium">üé§ Call Upload</span>
                <span class="badge premium">üëî Manager Dashboard</span>
            </div>
        </div>

        <div class="role-selector">
            <div class="role-btn active" onclick="setRole('agent')" id="roleAgent">
                <h3>üéß I'm an Agent</h3>
                <p>Practice retention skills and track my progress</p>
            </div>
            <div class="role-btn" onclick="setRole('manager')" id="roleManager">
                <h3>üëî I'm a Manager</h3>
                <p>View team analytics and manage training</p>
            </div>
        </div>

        <div class="user-panel">
            <div class="user-input">
                <label for="agentName">Your Name:</label>
                <input type="text" id="agentName" placeholder="Enter your name" onchange="loadUserData()">
                <button class="btn btn-primary" onclick="loadUserData()">Load My Progress</button>
            </div>
            <div class="user-stats" id="userStats">
                <div class="stat-box">
                    <div class="label">Total Sessions</div>
                    <div class="value" id="totalSessions">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg Score</div>
                    <div class="value" id="avgScore">0%</div>
                </div>
                <div class="stat-box">
                    <div class="label">Best Scenario</div>
                    <div class="value" id="bestScenario" style="font-size: 1.2em;">-</div>
                </div>
                <div class="stat-box">
                    <div class="label">Improvement</div>
                    <div class="value" id="improvement">-</div>
                </div>
                <div class="stat-box">
                    <div class="label">Current Level</div>
                    <div class="value" id="currentLevel" style="font-size: 1.2em;">Beginner</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('training')">üéØ Training</button>
                <button class="tab-button" onclick="switchTab('history')">üìö My History</button>
                <button class="tab-button" onclick="switchTab('insights')">üí° Insights</button>
                <button class="tab-button" onclick="switchTab('leaderboard')">üèÜ Leaderboard</button>
                <button class="tab-button" onclick="switchTab('upload')">üé§ Upload Calls</button>
                <button class="tab-button manager-only" onclick="switchTab('teamanalytics')" style="display: none;" id="tabTeamAnalytics">üìä Team Analytics</button>
                <button class="tab-button manager-only" onclick="switchTab('managerdash')" style="display: none;" id="tabManagerDash">üëî Manager Dashboard</button>
            </div>

            <div id="training" class="tab-content active">
                <div id="adaptiveNotice" class="adaptive-notice" style="display: none;">
                    <strong>üéØ Adaptive Training Active:</strong> <span id="adaptiveMessage"></span>
                </div>

                <div class="scenario-selector">
                    <label for="scenario">Select Scenario:</label>
                    <select id="scenario" onchange="updateScenarioInfo()">
                        <option value="auto">ü§ñ Auto-Select (Adaptive)</option>
                        <option value="moving">Moving (Random: Local or Out of State)</option>
                        <option value="financial">Budget Concerns - Lost Job</option>
                        <option value="bad_service">Missed Appointments</option>
                        <option value="not_working">Weeds Still Present</option>
                        <option value="competitor">Cheaper Competitor Offer</option>
                    </select>
                </div>

                <div class="scenario-info" id="scenarioInfo">
                    <h3>Ready to Begin</h3>
                    <p>Enter your name above and click "Start Training"</p>
                </div>

                <div class="metrics-display" id="metricsDisplay" style="display: none;">
                    <div><strong>Customer Receptiveness:</strong></div>
                    <div class="receptiveness-bar-container">
                        <div class="receptiveness-bar" id="receptivenessBar"></div>
                    </div>
                    <span id="receptivenessText">50%</span>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div><strong>Good Moves:</strong> <span id="goodMovesCount">0</span></div>
                        <div><strong>Bad Moves:</strong> <span id="badMovesCount">0</span></div>
                        <div><strong>Exchanges:</strong> <span id="exchangesCount">0</span></div>
                    </div>
                </div>

                <div class="status waiting" id="status">Ready to Start</div>

                <div class="controls">
                    <button class="btn btn-primary" id="startBtn" onclick="startTraining()">‚ñ∂Ô∏è Start Training</button>
                    <button class="btn btn-primary" id="endBtn" onclick="endCall()" disabled style="background: #f56565;">‚èπÔ∏è End Call</button>
                </div>

                <div class="input-area">
                    <textarea id="agentInput" placeholder="Type your response here..." disabled></textarea>
                    <button class="btn btn-primary" id="sendBtn" onclick="sendResponse()" style="width: 100%; margin-top: 10px;" disabled>üì§ Send Response</button>
                </div>

                <div class="conversation" id="conversation">
                    <p style="color: #a0aec0; text-align: center;">Conversation will appear here...</p>
                </div>
            </div>

            <div id="history" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>My Training History</h2>
                    <button class="btn btn-export" onclick="exportMyData()">üì• Export My Data to Excel</button>
                </div>
                <div class="history-list" id="historyList">
                    <p style="color: #a0aec0; text-align: center;">No training sessions yet.</p>
                </div>
            </div>

            <div id="insights" class="tab-content">
                <h2>Personal Insights & Progress</h2>
                
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                    <p style="color: #718096;">Progress chart will appear after 3+ sessions</p>
                </div>

                <div class="insights-grid" id="insightsGrid">
                    <div class="insight-card">
                        <h4>üí™ Your Strengths</h4>
                        <p id="strengths">Complete more sessions to see patterns...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üéØ Focus Areas</h4>
                        <p id="focusAreas">Complete more sessions to see patterns...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üìà Progress Trend</h4>
                        <p id="progressTrend">Complete more sessions to see trends...</p>
                    </div>
                    <div class="insight-card">
                        <h4>üèÖ Recommended Next</h4>
                        <p id="recommended">Try different scenario types for balanced training</p>
                    </div>
                    <div class="insight-card">
                        <h4>‚ö° Training Velocity</h4>
                        <p id="velocity">-</p>
                    </div>
                    <div class="insight-card">
                        <h4>üéì Skill Level</h4>
                        <p id="skillLevel">Beginner</p>
                    </div>
                </div>
            </div>

            <div id="leaderboard" class="tab-content">
                <h2>Team Leaderboard</h2>
                <p style="margin-bottom: 20px; color: #4a5568;">Top performers based on average scores across all sessions</p>
                <div class="leaderboard" id="leaderboardList">
                    <p style="color: #a0aec0; text-align: center;">No data yet.</p>
                </div>
            </div>

            <div id="upload" class="tab-content">
                <h2>Upload Real Customer Calls</h2>
                <div class="alert-box info">
                    <strong>üí° How it works:</strong> Upload recordings of actual customer cancellation calls. The system will analyze them and create custom training scenarios based on real situations your team faces.
                </div>

                <div class="upload-zone" id="uploadZone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                    <h3>üìÅ Drop audio files here or click to browse</h3>
                    <p>Supported formats: MP3, WAV, M4A</p>
                    <input type="file" id="fileInput" accept=".mp3,.wav,.m4a" style="display: none;" multiple onchange="handleFiles(this.files)">
                </div>

                <div class="call-list" id="callList">
                    <!-- Uploaded calls will appear here -->
                </div>
            </div>

            <div id="teamanalytics" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Team Analytics Dashboard</h2>
                    <button class="btn btn-export" onclick="exportTeamData()">üì• Export Team Report to Excel</button>
                </div>

                <div class="team-metrics">
                    <div class="metric-card">
                        <div class="value" id="teamTotalSessions">0</div>
                        <div class="label">Total Sessions</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamAvgScore">0%</div>
                        <div class="label">Team Avg Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamActiveAgents">0</div>
                        <div class="label">Active Agents</div>
                    </div>
                    <div class="metric-card">
                        <div class="value" id="teamImprovement">-</div>
                        <div class="label">Team Improvement</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Team Performance Trends</h3>
                    <div class="chart-container">
                        <p style="color: #718096;">Team performance chart</p>
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Scenario Performance Breakdown</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>Moving Scenarios</h4>
                            <p id="movingPerf">Avg: -</p>
                        </div>
                        <div class="insight-card">
                            <h4>Financial Scenarios</h4>
                            <p id="financialPerf">Avg: -</p>
                        </div>
                        <div class="insight-card">
                            <h4>Bad Service Scenarios</h4>
                            <p id="badServicePerf">Avg: -</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚ö†Ô∏è Agents Needing Support</h3>
                    <div id="needsSupport">
                        <p style="color: #a0aec0;">All agents are performing well!</p>
                    </div>
                </div>
            </div>

            <div id="managerdash" class="tab-content">
                <h2>Manager Dashboard</h2>
                
                <div class="alert-box warning">
                    <strong>üéØ Action Items:</strong> <span id="actionItems">Review agents with declining scores</span>
                </div>

                <div class="card">
                    <h3>üë• Agent Performance Overview</h3>
                    <table class="agent-table" id="agentTable">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Sessions</th>
                                <th>Avg Score</th>
                                <th>Improvement</th>
                                <th>Last Active</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="agentTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #a0aec0;">No agent data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h3>üéì Training Recommendations</h3>
                    <div id="trainingRecs">
                        <p>‚Ä¢ Schedule weekly team training sessions</p>
                        <p>‚Ä¢ Focus on bad service scenarios (lowest team score)</p>
                        <p>‚Ä¢ Recognize top performers in team meeting</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Scenario definitions with difficulty levels
        const SCENARIOS = {
            moving: { name: "Moving", difficulty: "easy", baseScore: 70 },
            financial: { name: "Financial Concerns", difficulty: "medium", baseScore: 60 },
            bad_service: { name: "Bad Service", difficulty: "hard", baseScore: 40 },
            not_working: { name: "Not Working", difficulty: "medium", baseScore: 55 },
            competitor: { name: "Competitor", difficulty: "medium", baseScore: 65 }
        };

        let currentUser = '';
        let currentRole = 'agent';
        let currentSession = null;
        let uploadedCalls = [];

        function setRole(role) {
            currentRole = role;
            document.getElementById('roleAgent').classList.toggle('active', role === 'agent');
            document.getElementById('roleManager').classList.toggle('active', role === 'manager');
            
            const showManager = role === 'manager';
            document.getElementById('tabTeamAnalytics').style.display = showManager ? 'block' : 'none';
            document.getElementById('tabManagerDash').style.display = showManager ? 'block' : 'none';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'history') loadHistory();
            if (tabName === 'insights') loadInsights();
            if (tabName === 'leaderboard') loadLeaderboard();
            if (tabName === 'teamanalytics') loadTeamAnalytics();
            if (tabName === 'managerdash') loadManagerDashboard();
        }

        function loadUserData() {
            currentUser = document.getElementById('agentName').value.trim();
            if (!currentUser) {
                alert('Please enter your name');
                return;
            }

            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser] || {
                sessions: [],
                totalSessions: 0,
                avgScore: 0,
                bestScenario: '-',
                improvement: 0,
                level: 'Beginner'
            };

            document.getElementById('totalSessions').textContent = user.totalSessions;
            document.getElementById('avgScore').textContent = user.avgScore + '%';
            document.getElementById('bestScenario').textContent = user.bestScenario;
            document.getElementById('improvement').textContent = user.improvement > 0 ? '+' + user.improvement + '%' : user.improvement + '%';
            document.getElementById('currentLevel').textContent = user.level || 'Beginner';

            updateStatus('Welcome back, ' + currentUser + '!', 'waiting');
            updateAdaptiveRecommendation();
        }

        function updateAdaptiveRecommendation() {
            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser];
            
            if (!user || user.sessions.length < 3) {
                document.getElementById('adaptiveNotice').style.display = 'none';
                return;
            }

            // Calculate which scenarios user struggles with
            const scenarioScores = {};
            user.sessions.forEach(s => {
                if (!scenarioScores[s.scenario]) scenarioScores[s.scenario] = [];
                scenarioScores[s.scenario].push(s.score);
            });

            const avgScores = {};
            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                avgScores[scenario] = scores.reduce((a, b) => a + b, 0) / scores.length;
            });

            const weakestScenario = Object.keys(avgScores).reduce((a, b) => 
                avgScores[a] < avgScores[b] ? a : b
            );

            document.getElementById('adaptiveNotice').style.display = 'block';
            document.getElementById('adaptiveMessage').textContent = 
                `Based on your history, we recommend practicing "${SCENARIOS[weakestScenario].name}" scenarios. Select "Auto-Select" to use adaptive training.`;
        }

        function updateScenarioInfo() {
            const scenario = document.getElementById('scenario').value;
            if (scenario === 'auto') {
                document.getElementById('scenarioInfo').innerHTML = `
                    <h3>ü§ñ Auto-Select Mode</h3>
                    <p>The system will choose the best scenario for your training based on your performance history.</p>
                `;
            }
        }

        function selectAdaptiveScenario() {
            const userData = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = userData[currentUser];
            
            if (!user || user.sessions.length < 3) {
                // Not enough data, select randomly
                const scenarios = Object.keys(SCENARIOS);
                return scenarios[Math.floor(Math.random() * scenarios.length)];
            }

            // Find weakest scenario
            const scenarioScores = {};
            user.sessions.forEach(s => {
                if (!scenarioScores[s.scenario]) scenarioScores[s.scenario] = [];
                scenarioScores[s.scenario].push(s.score);
            });

            const avgScores = {};
            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                avgScores[scenario] = scores.reduce((a, b) => a + b, 0) / scores.length;
            });

            return Object.keys(avgScores).reduce((a, b) => 
                avgScores[a] < avgScores[b] ? a : b
            );
        }

        function startTraining() {
            if (!currentUser) {
                alert('Please enter your name first');
                return;
            }

            let scenario = document.getElementById('scenario').value;
            if (scenario === 'auto') {
                scenario = selectAdaptiveScenario();
            }

            currentSession = {
                user: currentUser,
                scenario: scenario,
                startTime: new Date().toISOString(),
                conversation: [],
                score: 0,
                goodMoves: 0,
                badMoves: 0
            };

            document.getElementById('startBtn').disabled = true;
            document.getElementById('endBtn').disabled = false;
            document.getElementById('agentInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('metricsDisplay').style.display = 'block';

            const difficulty = SCENARIOS[scenario].difficulty;
            const difficultyBadge = `<span class="difficulty-badge ${difficulty}">${difficulty.toUpperCase()}</span>`;

            document.getElementById('scenarioInfo').innerHTML = `
                <h3>${SCENARIOS[scenario].name} ${difficultyBadge}</h3>
                <p>Practice your retention skills with this scenario!</p>
            `;

            document.getElementById('conversation').innerHTML = '<div class="message customer"><strong>üë§ Customer</strong>Hi, I need to cancel my service.</div>';
            currentSession.conversation.push({ role: 'customer', content: 'Hi, I need to cancel my service.' });

            updateStatus('Your turn - Type your response', 'waiting');
        }

        function sendResponse() {
            const input = document.getElementById('agentInput');
            const response = input.value.trim();

            if (!response) {
                alert('Please type a response first');
                return;
            }

            currentSession.conversation.push({ role: 'agent', content: response });
            
            const conversationEl = document.getElementById('conversation');
            conversationEl.innerHTML += `<div class="message agent"><strong>üéß You</strong>${response}</div>`;
            conversationEl.scrollTop = conversationEl.scrollHeight;
            
            input.value = '';

            // Analyze response quality
            const hasEmpathy = /understand|sorry|appreciate|thank/i.test(response);
            const hasSolution = /offer|can|help|would|option|plan/i.test(response);
            const isPushy = /must|should|need to|have to/i.test(response);

            if (hasEmpathy) currentSession.goodMoves++;
            if (hasSolution) currentSession.goodMoves++;
            if (isPushy) currentSession.badMoves++;

            // Simulate customer response
            setTimeout(() => {
                const customerResponse = hasEmpathy && hasSolution ? 
                    "That's helpful, thank you. Let me think about those options." :
                    isPushy ? 
                    "I appreciate your time, but I've made up my mind." :
                    "I understand, but I still need to cancel.";
                
                currentSession.conversation.push({ role: 'customer', content: customerResponse });
                conversationEl.innerHTML += `<div class="message customer"><strong>üë§ Customer</strong>${customerResponse}</div>`;
                conversationEl.scrollTop = conversationEl.scrollHeight;

                // Update metrics
                const exchanges = Math.floor(currentSession.conversation.length / 2);
                document.getElementById('exchangesCount').textContent = exchanges;
                document.getElementById('goodMovesCount').textContent = currentSession.goodMoves;
                document.getElementById('badMovesCount').textContent = currentSession.badMoves;
                
                const baseScore = SCENARIOS[currentSession.scenario].baseScore;
                const score = Math.min(100, Math.max(0, baseScore + (currentSession.goodMoves * 10) - (currentSession.badMoves * 15)));
                document.getElementById('receptivenessBar').style.width = score + '%';
                document.getElementById('receptivenessText').textContent = score + '%';
                currentSession.score = score;
            }, 1500);
        }

        function endCall() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('endBtn').disabled = true;
            document.getElementById('agentInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;

            currentSession.endTime = new Date().toISOString();
            
            saveSession(currentSession);
            updateStatus('Session complete! Check your history and insights.', 'waiting');
            
            loadUserData();
        }

        function saveSession(session) {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            
            if (!users[currentUser]) {
                users[currentUser] = {
                    sessions: [],
                    totalSessions: 0,
                    avgScore: 0,
                    bestScenario: '-',
                    improvement: 0,
                    level: 'Beginner'
                };
            }

            users[currentUser].sessions.push(session);
            users[currentUser].totalSessions++;
            
            const scores = users[currentUser].sessions.map(s => s.score);
            users[currentUser].avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            
            const scenarioCounts = {};
            users[currentUser].sessions.forEach(s => {
                scenarioCounts[s.scenario] = (scenarioCounts[s.scenario] || 0) + 1;
            });
            users[currentUser].bestScenario = Object.keys(scenarioCounts).reduce((a, b) => 
                scenarioCounts[a] > scenarioCounts[b] ? a : b
            );

            if (scores.length >= 2) {
                const recent = scores.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, scores.length);
                const earlier = scores.slice(0, -3).reduce((a, b) => a + b, 0) / Math.max(1, scores.length - 3);
                users[currentUser].improvement = Math.round(recent - earlier);
            }

            // Calculate level
            const avgScore = users[currentUser].avgScore;
            const totalSessions = users[currentUser].totalSessions;
            users[currentUser].level = 
                avgScore >= 80 && totalSessions >= 10 ? 'Expert' :
                avgScore >= 70 && totalSessions >= 5 ? 'Advanced' :
                avgScore >= 60 && totalSessions >= 3 ? 'Intermediate' :
                'Beginner';

            localStorage.setItem('springtouch_users', JSON.stringify(users));
        }

        function loadHistory() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length === 0) {
                document.getElementById('historyList').innerHTML = '<p style="color: #a0aec0; text-align: center;">No training sessions yet.</p>';
                return;
            }

            let html = '';
            [...user.sessions].reverse().forEach((session, index) => {
                const date = new Date(session.startTime).toLocaleString();
                const difficulty = SCENARIOS[session.scenario].difficulty;
                html += `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${SCENARIOS[session.scenario].name}</strong>
                                <span class="difficulty-badge ${difficulty}">${difficulty}</span>
                                <div class="date">${date}</div>
                                <div style="color: #4a5568; font-size: 0.9em; margin-top: 5px;">
                                    ${session.goodMoves} good moves, ${session.badMoves} bad moves
                                </div>
                            </div>
                            <div class="score">${session.score}%</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('historyList').innerHTML = html;
        }

        function loadInsights() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length < 3) {
                return;
            }

            const scores = user.sessions.map(s => s.score);
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;

            document.getElementById('strengths').textContent = 
                avgScore > 75 ? 'Excellent retention skills overall! Strong empathy and solution offering.' :
                avgScore > 60 ? 'Good empathy and problem-solving. Consistent performance.' :
                'Building foundation skills. Keep practicing!';

            document.getElementById('focusAreas').textContent = 
                avgScore < 60 ? 'Work on empathy statements and offering specific solutions' :
                avgScore < 75 ? 'Try more difficult scenarios to challenge yourself' :
                'Maintain consistency. Consider mentoring newer agents.';

            const trend = scores.slice(-3).reduce((a, b) => a + b) / 3 - scores.slice(0, 3).reduce((a, b) => a + b) / 3;
            document.getElementById('progressTrend').textContent = 
                trend > 10 ? 'üìà Improving significantly! Up ' + Math.round(trend) + '% from early sessions' :
                trend > 0 ? '‚û°Ô∏è Steady improvement. Up ' + Math.round(trend) + '%' :
                trend > -5 ? 'üìä Maintaining performance' :
                'üìâ Slight decline. Consider refresher training.';

            document.getElementById('recommended').textContent = 
                'Try ' + (user.bestScenario === 'financial' ? 'bad_service' : 'financial') + ' scenarios to broaden skills';

            // Training velocity
            const lastSession = new Date(user.sessions[user.sessions.length - 1].startTime);
            const firstSession = new Date(user.sessions[0].startTime);
            const daysBetween = Math.floor((lastSession - firstSession) / (1000 * 60 * 60 * 24)) || 1;
            const sessionsPerWeek = (user.sessions.length / daysBetween * 7).toFixed(1);
            document.getElementById('velocity').textContent = sessionsPerWeek + ' sessions/week';

            document.getElementById('skillLevel').textContent = user.level;
        }

        function loadLeaderboard() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const leaderboard = Object.keys(users)
                .map(name => ({
                    name: name,
                    avgScore: users[name].avgScore,
                    sessions: users[name].totalSessions,
                    level: users[name].level
                }))
                .sort((a, b) => b.avgScore - a.avgScore)
                .slice(0, 10);

            if (leaderboard.length === 0) {
                document.getElementById('leaderboardList').innerHTML = '<p style="color: #a0aec0; text-align: center;">No data yet.</p>';
                return;
            }

            let html = '';
            leaderboard.forEach((user, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                html += `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">${medal || (index + 1)}</div>
                        <div class="leaderboard-name">
                            ${user.name}
                            <div style="font-size: 0.8em; color: #718096;">${user.level}</div>
                        </div>
                        <div class="leaderboard-score">${user.avgScore}%</div>
                        <div style="color: #718096; font-size: 0.9em;">${user.sessions} sessions</div>
                    </div>
                `;
            });

            document.getElementById('leaderboardList').innerHTML = html;
        }

        function loadTeamAnalytics() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const allUsers = Object.values(users);
            
            if (allUsers.length === 0) {
                return;
            }

            const totalSessions = allUsers.reduce((sum, u) => sum + u.totalSessions, 0);
            const avgScore = Math.round(allUsers.reduce((sum, u) => sum + u.avgScore, 0) / allUsers.length);
            const activeAgents = allUsers.filter(u => u.totalSessions > 0).length;
            
            const allScores = allUsers.flatMap(u => u.sessions.map(s => s.score));
            const recentScores = allScores.slice(-20);
            const earlierScores = allScores.slice(0, -20);
            const improvement = recentScores.length > 0 && earlierScores.length > 0 ?
                Math.round(recentScores.reduce((a, b) => a + b) / recentScores.length - 
                           earlierScores.reduce((a, b) => a + b) / earlierScores.length) : 0;

            document.getElementById('teamTotalSessions').textContent = totalSessions;
            document.getElementById('teamAvgScore').textContent = avgScore + '%';
            document.getElementById('teamActiveAgents').textContent = activeAgents;
            document.getElementById('teamImprovement').textContent = improvement > 0 ? '+' + improvement + '%' : improvement + '%';

            // Scenario performance
            const scenarioScores = {};
            allUsers.forEach(user => {
                user.sessions.forEach(session => {
                    if (!scenarioScores[session.scenario]) scenarioScores[session.scenario] = [];
                    scenarioScores[session.scenario].push(session.score);
                });
            });

            Object.keys(scenarioScores).forEach(scenario => {
                const scores = scenarioScores[scenario];
                const avg = Math.round(scores.reduce((a, b) => a + b) / scores.length);
                const elementId = scenario + 'Perf';
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = `Avg: ${avg}% (${scores.length} attempts)`;
                }
            });

            // Agents needing support
            const needsSupport = allUsers.filter(u => u.avgScore < 60 || u.improvement < -5);
            if (needsSupport.length > 0) {
                let html = '<ul>';
                needsSupport.forEach(user => {
                    html += `<li><strong>${user.name}</strong> - Avg: ${user.avgScore}%, Trend: ${user.improvement}%</li>`;
                });
                html += '</ul>';
                document.getElementById('needsSupport').innerHTML = html;
            }
        }

        function loadManagerDashboard() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const allUsers = Object.entries(users).map(([name, data]) => ({
                name,
                ...data
            }));

            if (allUsers.length === 0) {
                return;
            }

            let tableHtml = '';
            allUsers.forEach(user => {
                const lastSession = user.sessions.length > 0 ? 
                    new Date(user.sessions[user.sessions.length - 1].startTime).toLocaleDateString() : 
                    'Never';
                
                const status = user.improvement > 5 ? '‚úÖ Improving' :
                               user.improvement < -5 ? '‚ö†Ô∏è Declining' :
                               user.avgScore > 70 ? '‚úì Good' : '‚ö†Ô∏è Needs Support';

                const statusColor = user.improvement > 5 ? '#10b981' :
                                   user.improvement < -5 ? '#f59e0b' :
                                   user.avgScore > 70 ? '#4a7c2c' : '#ef4444';

                tableHtml += `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.totalSessions}</td>
                        <td>
                            ${user.avgScore}%
                            <div class="progress-bar" style="margin-top: 5px;">
                                <div class="progress-fill" style="width: ${user.avgScore}%"></div>
                            </div>
                        </td>
                        <td style="color: ${user.improvement > 0 ? '#10b981' : '#ef4444'}">
                            ${user.improvement > 0 ? '+' : ''}${user.improvement}%
                        </td>
                        <td>${lastSession}</td>
                        <td style="color: ${statusColor}; font-weight: 600;">${status}</td>
                    </tr>
                `;
            });

            document.getElementById('agentTableBody').innerHTML = tableHtml;

            // Action items
            const declining = allUsers.filter(u => u.improvement < -5).length;
            const needsTraining = allUsers.filter(u => u.avgScore < 60).length;
            const inactive = allUsers.filter(u => {
                if (u.sessions.length === 0) return true;
                const lastSession = new Date(u.sessions[u.sessions.length - 1].startTime);
                const daysSince = (Date.now() - lastSession) / (1000 * 60 * 60 * 24);
                return daysSince > 7;
            }).length;

            let actionItems = [];
            if (declining > 0) actionItems.push(`${declining} agent(s) showing declining performance`);
            if (needsTraining > 0) actionItems.push(`${needsTraining} agent(s) below 60% average`);
            if (inactive > 0) actionItems.push(`${inactive} agent(s) inactive for 7+ days`);

            document.getElementById('actionItems').textContent = 
                actionItems.length > 0 ? actionItems.join(' ‚Ä¢ ') : 'All agents performing well!';
        }

        function exportMyData() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            const user = users[currentUser];

            if (!user || user.sessions.length === 0) {
                alert('No data to export');
                return;
            }

            const data = user.sessions.map(session => ({
                'Date': new Date(session.startTime).toLocaleString(),
                'Scenario': SCENARIOS[session.scenario].name,
                'Difficulty': SCENARIOS[session.scenario].difficulty,
                'Score': session.score + '%',
                'Good Moves': session.goodMoves,
                'Bad Moves': session.badMoves,
                'Exchanges': Math.floor(session.conversation.length / 2)
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Training History');
            XLSX.writeFile(wb, `${currentUser}_Training_History_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportTeamData() {
            const users = JSON.parse(localStorage.getItem('springtouch_users') || '{}');
            
            const summary = Object.entries(users).map(([name, data]) => ({
                'Agent Name': name,
                'Total Sessions': data.totalSessions,
                'Average Score': data.avgScore + '%',
                'Best Scenario': data.bestScenario,
                'Improvement': data.improvement + '%',
                'Level': data.level || 'Beginner'
            }));

            const allSessions = [];
            Object.entries(users).forEach(([name, data]) => {
                data.sessions.forEach(session => {
                    allSessions.push({
                        'Agent': name,
                        'Date': new Date(session.startTime).toLocaleString(),
                        'Scenario': SCENARIOS[session.scenario].name,
                        'Score': session.score + '%',
                        'Good Moves': session.goodMoves,
                        'Bad Moves': session.badMoves
                    });
                });
            });

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(summary);
            const ws2 = XLSX.utils.json_to_sheet(allSessions);
            XLSX.utils.book_append_sheet(wb, ws1, 'Team Summary');
            XLSX.utils.book_append_sheet(wb, ws2, 'All Sessions');
            XLSX.writeFile(wb, `Spring_Touch_Team_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            document.getElementById('uploadZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.match('audio.*')) {
                    const call = {
                        name: file.name,
                        size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                        uploadDate: new Date().toLocaleString(),
                        processed: false
                    };
                    
                    uploadedCalls.push(call);
                    displayUploadedCalls();
                }
            });
        }

        function displayUploadedCalls() {
            let html = '<h3 style="margin-top: 20px;">Uploaded Calls</h3>';
            uploadedCalls.forEach((call, index) => {
                html += `
                    <div class="call-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üé§ ${call.name}</strong>
                                <div style="color: #718096; font-size: 0.9em;">${call.size} ‚Ä¢ ${call.uploadDate}</div>
                            </div>
                            <div>
                                ${call.processed ? 
                                    '<span class="badge" style="background: #10b981;">‚úì Processed</span>' : 
                                    '<span class="badge" style="background: #f59e0b;">‚è≥ Processing...</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('callList').innerHTML = html;

            // Simulate processing
            setTimeout(() => {
                uploadedCalls.forEach(call => call.processed = true);
                displayUploadedCalls();
            }, 3000);
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
    </script>
</body>
</html>
